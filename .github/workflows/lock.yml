# SPDX-FileCopyrightText: Andrew Hayzen <ahayzen@gmail.com>
#
# SPDX-License-Identifier: MPL-2.0

name: lock update

on:
  schedule:
    # Note this is in UTC
    #
    # 2200 is 0700 in Japan and 2200 or 2300 in UK so has minimal impact
    - cron: '1 22 * * *'
  workflow_dispatch:

permissions:
  # So that we can trigger the workflow
  actions: write
  # So that a pull request and commit can be created
  pull-requests: write
  contents: write

jobs:
  lock-updater:
    name: nix flake update
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/nix-installer-action@v10
      - uses: DeterminateSystems/update-flake-lock@v21
        with:
          pr-title: "chore: update flake.lock"

      # We need to manually trigger CI status checks
      # as github prevents workflows automatically running to prevent loops
      - name: trigger ci status checks
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'check.yml',
              ref: 'update_flake_lock_action',
            })

      - name: trigger auto merge
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'auto-merge.yml',
              ref: 'update_flake_lock_action',
            })
